# Техническая документация

## Архитектура проекта

### Структура файлов
```
collect-sol/
├── collect-sol.js      # Основной скрипт
├── wallets.txt         # Файл с приватными ключами
├── balances.json       # Результаты проверки балансов
├── package.json        # Зависимости проекта
├── README.md           # Основная документация
├── DOCUMENTATION.md    # Техническая документация
├── LICENSE             # Лицензия
└── .gitignore          # Игнорируемые файлы
```

## Технические детали

### Зависимости
- `@solana/web3.js` - Основная библиотека для работы с Solana
- `bs58` - Декодирование Base58 приватных ключей
- `fs` - Работа с файловой системой (встроенный модуль Node.js)
- `readline` - Интерактивный ввод (встроенный модуль Node.js)

### Функции

#### `loadKeypairsFromTxt(filePath)`
Загружает приватные ключи из текстового файла и преобразует их в объекты Keypair.

**Параметры:**
- `filePath` (string) - Путь к файлу с приватными ключами

**Возвращает:**
- Array<Keypair> - Массив объектов Keypair

**Особенности:**
- Автоматически удаляет пустые строки
- Декодирует Base58 строки в байтовые массивы
- Обрабатывает ошибки некорректных ключей

#### `checkBalances()`
Асинхронная функция для проверки балансов всех кошельков.

**Процесс:**
1. Загружает кошельки из файла
2. Для каждого кошелька запрашивает баланс через RPC
3. Конвертирует lamports в SOL
4. Сохраняет результаты в JSON файл
5. Выводит информацию в консоль

**Выходной формат JSON:**
```json
[
  {
    "wallet": "публичный_адрес_кошелька",
    "balanceLamports": 1000000000,
    "balanceSol": 1.0
  }
]
```

#### `collectAll()`
Асинхронная функция для консолидации средств.

**Процесс:**
1. Загружает кошельки из файла
2. Для каждого кошелька:
   - Проверяет баланс
   - Рассчитывает сумму для перевода (баланс - 5000 lamports на комиссию)
   - Создает транзакцию перевода
   - Отправляет и подтверждает транзакцию

**Параметры транзакции:**
- `skipPreflight`: false - Выполняет предварительную симуляцию
- `commitment`: 'confirmed' - Уровень подтверждения
- `maxRetries`: 5 - Максимальное количество повторных попыток
- `timeout`: 60000ms - Таймаут ожидания подтверждения

## Конфигурация

### Константы
```javascript
const RPC_URL = clusterApiUrl('mainnet-beta');
const WALLET_KEYS_FILE = './wallets.txt';
const TARGET_ADDRESS = new PublicKey('ВСТАВЬТЕ_ТУТ_ЦЕЛЕВОЙ_АДРЕС');
const OUTPUT_JSON_FILE = './balances.json';
```

### RPC провайдеры
- **Solana Foundation**: `https://api.mainnet-beta.solana.com`
- **Ankr**: `https://rpc.ankr.com/solana`
- **QuickNode**: Персональные RPC узлы
- **GenesysGo**: `https://ssc-dao.genesysgo.net/`

## Безопасность

### Рекомендации
1. **Приватные ключи**: Никогда не коммитьте `wallets.txt` в репозиторий
2. **Тестирование**: Всегда тестируйте на devnet перед использованием на mainnet
3. **Резервные копии**: Создайте резервные копии всех приватных ключей
4. **Проверка адресов**: Дважды проверяйте TARGET_ADDRESS перед запуском

### Потенциальные риски
- **Потеря средств**: Неправильный TARGET_ADDRESS
- **Высокие комиссии**: Перегруженная сеть может увеличить стоимость транзакций
- **RPC лимиты**: Публичные RPC могут иметь ограничения по запросам

## Производительность

### Оптимизация
- Используйте частный RPC для лучшей скорости и надежности
- Рассмотрите возможность параллельной обработки кошельков
- Мониторьте нагрузку на сеть для выбора оптимального времени

### Мониторинг транзакций
Все транзакции можно отслеживать через:
- [Solana Explorer](https://explorer.solana.com/)
- [Solscan](https://solscan.io/)
- [SolanaBeach](https://solanabeach.io/)

## Обработка ошибок

### Типичные ошибки
1. **Insufficient funds**: Недостаточно средств для комиссии
2. **Invalid signature**: Неверный приватный ключ
3. **RPC error**: Проблемы с подключением к узлу
4. **Transaction timeout**: Транзакция не подтверждена в отведенное время

### Решения
- Проверьте баланс перед отправкой транзакции
- Используйте надежный RPC провайдер
- Увеличьте таймаут для медленных сетей
- Проверьте формат приватных ключей

## Расширение функциональности

### Возможные улучшения
1. **GUI интерфейс**: Веб-интерфейс для управления
2. **Расписание**: Автоматическая консолидация по расписанию
3. **Уведомления**: Email/Telegram уведомления о транзакциях
4. **Токены SPL**: Поддержка других токенов кроме SOL
5. **Мультиподпись**: Поддержка multisig кошельков

### API интеграция
Возможна интеграция с:
- Portfolio trackers (CoinTracker, Koinly)
- Tax software
- DeFi protocols
- NFT marketplaces